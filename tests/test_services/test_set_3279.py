""" Code is generated by ucloud-model, DO NOT EDIT IT. """

import pytest
import logging

from ucloud.core import exc
from ucloud.testing import env, funcs, op, utest

logger = logging.getLogger(__name__)


scenario = utest.Scenario(255)


@pytest.mark.skipif(env.is_ut(), reason=env.get_skip_reason())
def test_set_3279(client: utest.Client, variables: dict):
    scenario.initial(variables)

    scenario.variables[
        "Image_Id_ucloud"
    ] = "#{u_get_image_resource($Region,$Zone)}"
    scenario.variables["saopaulo_image"] = "uimage-1bkjka"

    scenario.run(client)


@scenario.step(
    max_retries=3,
    retry_interval=1,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("str_eq", "Action", "DescribeImageResponse"),
    ],
    action="DescribeImage",
)
def describe_image_00(client: utest.Client, variables: dict):
    d = {
        "Zone": variables.get("Zone"),
        "Region": variables.get("Region"),
        "OsType": "Linux",
        "ImageType": "Base",
    }

    try:
        resp = client.uhost().describe_image(d)
    except exc.RetCodeException as e:
        resp = e.json()

    variables["Image_Id_ucloud"] = utest.value_at_path(
        resp, "ImageSet.0.ImageId"
    )
    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=5,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 0)],
    action="CreateUHostInstance",
)
def create_uhost_instance_01(client: utest.Client, variables: dict):
    d = {
        "Zone": variables.get("Zone"),
        "UHostType": "Normal",
        "TimemachineFeature": "No",
        "Tag": "Default",
        "Region": variables.get("Region"),
        "Password": "VXFhNzg5VGVzdCFAIyQ7LA==",
        "Name": "ulb-host",
        "Memory": 1024,
        "LoginMode": "Password",
        "ImageId": variables.get("Image_Id_ucloud"),
        "HotplugFeature": False,
        "DiskSpace": 0,
        "CPU": 1,
    }

    try:
        resp = client.uhost().create_uhost_instance(d)
    except exc.RetCodeException as e:
        resp = e.json()

    variables["UHostId_01"] = utest.value_at_path(resp, "UHostIds.0")
    variables["IP_01"] = utest.value_at_path(resp, "IPs.0")
    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=180,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 0)],
    action="CreateULB",
)
def create_ulb_02(client: utest.Client, variables: dict):
    d = {
        "ULBName": "测试",
        "Tag": "Default",
        "Region": variables.get("Region"),
        "InnerMode": "No",
    }

    try:
        resp = client.ulb().create_ulb(d)
    except exc.RetCodeException as e:
        resp = e.json()

    variables["ULBId"] = utest.value_at_path(resp, "ULBId")
    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=3,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("str_eq", "DataSet.0.ULBId", variables.get("ULBId")),
    ],
    action="DescribeULB",
)
def describe_ulb_03(client: utest.Client, variables: dict):
    d = {
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Offset": 0,
        "Limit": 60,
    }

    try:
        resp = client.ulb().describe_ulb(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 4107)],
    action="CreateVServer",
)
def create_vserver_04(client: utest.Client, variables: dict):
    d = {
        "VServerName": "vserver-test",
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Protocol": "HTTP",
        "PersistenceType": "UserDefined",
        "PersistenceInfo": "huangchao",
        "Method": "Roundrobin",
        "ListenType": "RequestProxy",
        "FrontendPort": 80,
        "ClientTimeout": 60,
    }

    try:
        resp = client.ulb().create_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("str_eq", "DataSet.0.ListenType", "RequestProxy"),
        ("str_eq", "DataSet.0.VServerName", "vserver-test"),
        ("str_eq", "DataSet.0.Protocol", "HTTP"),
        ("str_eq", "DataSet.0.FrontendPort", 80),
        ("str_eq", "DataSet.0.Method", "Roundrobin"),
        ("str_eq", "DataSet.0.ClientTimeout", "60"),
    ],
    action="DescribeVServer",
)
def describe_vserver_05(client: utest.Client, variables: dict):
    d = {"ULBId": variables.get("ULBId"), "Region": variables.get("Region")}

    try:
        resp = client.ulb().describe_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    variables["VServerId"] = utest.value_at_path(resp, "DataSet.0.VServerId")
    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 63016)],
    action="AllocateBackendBatch",
)
def allocate_backend_batch_06(client: utest.Client, variables: dict):
    d = {
        "VServerId": variables.get("VServerId"),
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Backends": [
            funcs.concat(
                variables.get("UHostId_01"),
                "|UHost|80|1|",
                variables.get("IP_01"),
            )
        ],
        "ApiVersion": 3,
    }

    try:
        resp = client.ulb().allocate_backend_batch(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("str_eq", "DataSet.0.ListenType", "RequestProxy"),
        ("str_eq", "DataSet.0.VServerName", "vserver-test"),
        ("str_eq", "DataSet.0.Protocol", "HTTP"),
        ("str_eq", "DataSet.0.FrontendPort", 80),
        ("str_eq", "DataSet.0.Method", "Roundrobin"),
        ("str_eq", "DataSet.0.ClientTimeout", "60"),
    ],
    action="DescribeVServer",
)
def describe_vserver_07(client: utest.Client, variables: dict):
    d = {"ULBId": variables.get("ULBId"), "Region": variables.get("Region")}

    try:
        resp = client.ulb().describe_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    variables["BackendId"] = utest.value_at_path(
        resp, "DataSet.0.BackendSet.0.BackendId"
    )
    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 0)],
    action="UpdateBackendAttribute",
)
def update_backend_attribute_08(client: utest.Client, variables: dict):
    d = {
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Port": 80,
        "Enabled": 0,
        "BackendId": variables.get("BackendId"),
    }

    try:
        resp = client.ulb().update_backend_attribute(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 0)],
    action="UpdateBackendAttributeBatch",
)
def update_backend_attribute_batch_09(client: utest.Client, variables: dict):
    d = {
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Attribute": [variables.get("BackendId")],
    }

    try:
        resp = client.invoke("UpdateBackendAttributeBatch", d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 4103)],
    action="ReleaseBackend",
)
def release_backend_10(client: utest.Client, variables: dict):
    d = {
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "BackendId": variables.get("BackendId"),
    }

    try:
        resp = client.ulb().release_backend(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=10,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("len_eq", "DataSet.0.BackendSet", 0),
    ],
    action="DescribeVServer",
)
def describe_vserver_11(client: utest.Client, variables: dict):
    d = {"ULBId": variables.get("ULBId"), "Region": variables.get("Region")}

    try:
        resp = client.ulb().describe_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 63016)],
    action="AllocateBackend",
)
def allocate_backend_12(client: utest.Client, variables: dict):
    d = {
        "VServerId": variables.get("VServerId"),
        "ULBId": variables.get("ULBId"),
        "ResourceType": "UHost",
        "ResourceId": variables.get("UHostId_01"),
        "Region": variables.get("Region"),
        "Port": 80,
        "Enabled": 1,
    }

    try:
        resp = client.ulb().allocate_backend(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("len_eq", "DataSet.0.BackendSet", 1),
    ],
    action="DescribeVServer",
)
def describe_vserver_13(client: utest.Client, variables: dict):
    d = {"ULBId": variables.get("ULBId"), "Region": variables.get("Region")}

    try:
        resp = client.ulb().describe_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 0)],
    action="UpdateULBAttribute",
)
def update_ulb_attribute_14(client: utest.Client, variables: dict):
    d = {
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Name": "测试-改",
    }

    try:
        resp = client.ulb().update_ulb_attribute(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 0)],
    action="UpdateVServerAttribute",
)
def update_vserver_attribute_15(client: utest.Client, variables: dict):
    d = {
        "VServerName": "vserver-gai",
        "VServerId": variables.get("VServerId"),
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
        "Protocol": "HTTPS",
        "PersistenceType": "ServerInsert",
        "Method": "Source",
    }

    try:
        resp = client.ulb().update_vserver_attribute(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [
        ("str_eq", "RetCode", 0),
        ("str_eq", "TotalCount", 1),
    ],
    action="DescribeVServer",
)
def describe_vserver_16(client: utest.Client, variables: dict):
    d = {
        "VServerId": variables.get("VServerId"),
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
    }

    try:
        resp = client.ulb().describe_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=20,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 4103)],
    action="DeleteVServer",
)
def delete_vserver_17(client: utest.Client, variables: dict):
    d = {
        "VServerId": variables.get("VServerId"),
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
    }

    try:
        resp = client.ulb().delete_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=5,
    fast_fail=False,
    action="DescribeVServer",
)
def describe_vserver_18(client: utest.Client, variables: dict):
    d = {
        "VServerId": variables.get("VServerId"),
        "ULBId": variables.get("ULBId"),
        "Region": variables.get("Region"),
    }

    try:
        resp = client.ulb().describe_vserver(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    validators=lambda variables: [("str_eq", "RetCode", 4103)],
    action="DeleteULB",
)
def delete_ulb_19(client: utest.Client, variables: dict):
    d = {"ULBId": variables.get("ULBId"), "Region": variables.get("Region")}

    try:
        resp = client.ulb().delete_ulb(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=10,
    retry_interval=10,
    startup_delay=0,
    fast_fail=False,
    action="DescribeULBSimple",
)
def describe_ulb_simple_20(client: utest.Client, variables: dict):
    d = {"ULBId": variables.get("ULBId"), "Region": variables.get("Region")}

    try:
        resp = client.invoke("DescribeULBSimple", d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=30,
    retry_interval=10,
    startup_delay=10,
    fast_fail=False,
    action="PoweroffUHostInstance",
)
def poweroff_uhost_instance_21(client: utest.Client, variables: dict):
    d = {
        "Zone": variables.get("Zone"),
        "UHostId": variables.get("UHostId_01"),
        "Region": variables.get("Region"),
    }

    try:
        resp = client.uhost().poweroff_uhost_instance(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp


@scenario.step(
    max_retries=30,
    retry_interval=10,
    startup_delay=60,
    fast_fail=False,
    action="TerminateUHostInstance",
)
def terminate_uhost_instance_22(client: utest.Client, variables: dict):
    d = {
        "Zone": variables.get("Zone"),
        "UHostId": variables.get("UHostId_01"),
        "Region": variables.get("Region"),
    }

    try:
        resp = client.uhost().terminate_uhost_instance(d)
    except exc.RetCodeException as e:
        resp = e.json()

    return resp
